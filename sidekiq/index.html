<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="https://user-images.githubusercontent.com/10556018/42560280-df45afde-8528-11e8-89b8-90ab96f65c50.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="https://user-images.githubusercontent.com/10556018/42560280-df45afde-8528-11e8-89b8-90ab96f65c50.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="https://user-images.githubusercontent.com/10556018/42560280-df45afde-8528-11e8-89b8-90ab96f65c50.png?v=5.1.4">


  <link rel="mask-icon" href="https://user-images.githubusercontent.com/10556018/42560280-df45afde-8528-11e8-89b8-90ab96f65c50.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Sidekiq," />










<meta name="description" content="job lifecycle Processed - successfully completed, and no further action will be taken. Failed - the number of times all jobs were executed by Sidekiq and  raised an error. Since the default retry poli">
<meta name="keywords" content="Sidekiq">
<meta property="og:type" content="article">
<meta property="og:title" content="Sidekiq">
<meta property="og:url" content="http://www.hailehuang.com/sidekiq/index.html">
<meta property="og:site_name" content="Haile&#39;s Blog">
<meta property="og:description" content="job lifecycle Processed - successfully completed, and no further action will be taken. Failed - the number of times all jobs were executed by Sidekiq and  raised an error. Since the default retry poli">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-images.githubusercontent.com/2991389/29632389-ddedb250-8810-11e7-8574-b94601ef2d8d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/10556018/47346040-ca4e1a00-d6de-11e8-9363-f014bf8bcbe9.png">
<meta property="og:image" content="https://camo.githubusercontent.com/7bda9dc773d43df7fcb7d5cb919c1eb217fde270/68747470733a2f2f662e636c6f75642e6769746875622e636f6d2f6173736574732f323931312f313631393436352f66343735323966322d353635372d313165332d386364312d3333383939656237326161642e706e67">
<meta property="og:updated_time" content="2019-02-25T16:13:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sidekiq">
<meta name="twitter:description" content="job lifecycle Processed - successfully completed, and no further action will be taken. Failed - the number of times all jobs were executed by Sidekiq and  raised an error. Since the default retry poli">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/2991389/29632389-ddedb250-8810-11e7-8574-b94601ef2d8d.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.hailehuang.com/sidekiq/"/>





  <title>Sidekiq | Haile's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5cfdffefc40643590b34d00829a1efa2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Haile's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hailehuang.com/sidekiq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haile Huang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://user-images.githubusercontent.com/10556018/53352661-27443000-395e-11e9-8d7b-86c57c4968aa.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Haile's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Sidekiq</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-23T18:04:49+08:00">
                2018-10-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ROR/" itemprop="url" rel="index">
                    <span itemprop="name">ROR</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/sidekiq/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="sidekiq/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="job-lifecycle"><a href="#job-lifecycle" class="headerlink" title="job lifecycle"></a>job lifecycle</h2><ul>
<li>Processed - successfully completed, and no further action will be taken.</li>
<li>Failed - the number of times all jobs were executed by Sidekiq and  raised an error. Since the default retry policy is 25, a single job can lead to Failed increasing by 25. It’s important to note that a job will never end up in Failed, as it’s a purely transitive state. The only possible final states are Processed or Dead.</li>
<li>Busy - currently processing.</li>
<li>Enqueued - waiting for a turn in the processing queue (listed in chronological order, by queue).</li>
<li>Retries - failed, but will be automatically retried sometime in the future (listed in chronological order).</li>
<li>Scheduled - configured to be run at some point in the future (may be enqueued when their processing time comes up).</li>
<li>Dead - will no longer be retried but is saved so it can be manually retried at some point in the near future.</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/2991389/29632389-ddedb250-8810-11e7-8574-b94601ef2d8d.png" alt="Alt text"></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="证明改变worker后重启Sidekiq-，之前的job用的是新的worker的代码"><a href="#证明改变worker后重启Sidekiq-，之前的job用的是新的worker的代码" class="headerlink" title="证明改变worker后重启Sidekiq ，之前的job用的是新的worker的代码"></a>证明改变<code>worker</code>后重启<code>Sidekiq</code> ，之前的<code>job</code>用的是新的<code>worker</code>的代码</h3><h4 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h4><p>新建一个<code>TestWorker</code>，作用就是输出<code>A</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class TestWorker</span><br><span class="line">  include Sidekiq::Worker</span><br><span class="line"></span><br><span class="line">  def perform()</span><br><span class="line">    puts &apos;=======================================A======================================&apos;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h4 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h4><p>进入<code>rails console</code>，约定1分钟后执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TestWorker.perform_in (Time.now + 60.seconds)</span><br></pre></td></tr></table></figure></p>
<h4 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h4><p>关闭<code>Sidekiq</code>，并修改<code>worker</code>，使其输出<code>B</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class TestWorker</span><br><span class="line">  include Sidekiq::Worker</span><br><span class="line"></span><br><span class="line">  def perform()</span><br><span class="line">    puts &apos;=======================================B======================================&apos;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h4 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h4><p>重启<code>Sidekiq</code>，看输出<br><img src="https://user-images.githubusercontent.com/10556018/47346040-ca4e1a00-d6de-11e8-9363-f014bf8bcbe9.png" alt="Alt text"></p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>由上图可得，输出的是<code>B</code><br>由此可以看出，<code>Redis</code>队列里存的只是<code>worker</code>的参数和名字，具体执行<code>worker</code>的时候，再去拿<code>worker</code>的代码</p>
<h3 id="优雅、安全的shut-down-Sidekiq"><a href="#优雅、安全的shut-down-Sidekiq" class="headerlink" title="优雅、安全的shut down Sidekiq"></a>优雅、安全的shut down <code>Sidekiq</code></h3><ol>
<li>在部署流程中尽早的发送<code>TSTP</code>信号，它会告诉<code>Sidekiq</code>停止接收新任务，然后继续执行手头的<code>job</code>直到结束</li>
<li>在部署流程中尽可能迟的发送<code>TERM</code>信号，它会告诉<code>Sidekiq</code>在N秒后exit</li>
</ol>
<p>在你的部署流程中使用<code>TSTP</code>+<code>TERM</code>会保证<code>Sidekiq</code>N秒后一定会exit，如果N秒后这个<code>job</code>还没有执行完毕，<code>Sidekiq</code>会把这个<code>job</code>返还给<code>Redis</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kill -TSTP pid</span><br><span class="line">//defaults to 8 seconds</span><br><span class="line">kill -TERM pid</span><br><span class="line">//25 seconds</span><br><span class="line">kill -TERM -t 25 pid</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>The TSTP signal is sent to a process by its controlling terminal to request it to stop temporarily. It is commonly initiated by the user pressing Control-Z. Unlike SIGSTOP, this process can register a signal handler for or ignore the signal.</p>
</blockquote>
<blockquote>
<p>The TERM signal is sent to a process to request its termination. Unlike the KILL signal, it can be caught and interpreted or ignored by the process. This signal allows the process to perform nice termination releasing resources and saving state if appropriate. It should be noted that SIGINT is nearly identical to SIGTERM.</p>
</blockquote>
<h3 id="保持job参数的简单"><a href="#保持job参数的简单" class="headerlink" title="保持job参数的简单"></a>保持<code>job</code>参数的简单</h3><ul>
<li><code>Sidekiq</code>传递给<code>Redis</code>的数据首先会使用<code>JSON.dump</code>去处理</li>
<li><code>Redis</code>传递给<code>Sidekiq</code>的数据会使用<code>JSON.load</code>去处理</li>
</ul>
<p>所以不要传递<code>symbols, named parameters or complex Ruby objects (like Date or Time!)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//bad</span><br><span class="line">quote = Quote.find(quote_id)</span><br><span class="line">SomeWorker.perform_async(quote)</span><br><span class="line"></span><br><span class="line">//good</span><br><span class="line">SomeWorker.perform_async(quote_id)</span><br></pre></td></tr></table></figure></p>
<h4 id="工作中的最佳实践"><a href="#工作中的最佳实践" class="headerlink" title="工作中的最佳实践"></a>工作中的最佳实践</h4><p>不要用<code>objects</code>，不要用<code>symbol</code>，我们只认准<code>string</code>！！！！</p>
<h3 id="保持job的幂等性和事务性"><a href="#保持job的幂等性和事务性" class="headerlink" title="保持job的幂等性和事务性"></a>保持<code>job</code>的<code>幂等性</code>和<code>事务性</code></h3><ul>
<li>幂等性：无副作用的运行多次</li>
<li>事务性：要么都成功，要么都失败</li>
</ul>
<h4 id="工作中的最佳实践-1"><a href="#工作中的最佳实践-1" class="headerlink" title="工作中的最佳实践"></a>工作中的最佳实践</h4><p>关于推送微信消息的<code>worker</code>，一个<code>worker</code>只推一条消息或者只推一个学生所关联家长的消息</p>
<h2 id="pro版本优点"><a href="#pro版本优点" class="headerlink" title="pro版本优点"></a><code>pro</code>版本优点</h2><h3 id="更好的可靠性"><a href="#更好的可靠性" class="headerlink" title="更好的可靠性"></a>更好的可靠性</h3><h4 id="Sidekiq客户端推送job到Redis"><a href="#Sidekiq客户端推送job到Redis" class="headerlink" title="Sidekiq客户端推送job到Redis"></a><code>Sidekiq</code>客户端推送<code>job</code>到<code>Redis</code></h4><h5 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h5><p>当从<code>Sidekiq</code>客户端推送<code>job</code>到<code>Redis</code>时，如果出现网络问题，<code>job</code>将会丢失</p>
<h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><p>客户端会维护一个<code>job</code>队列，只有推送成功，<code>job</code>才会出队</p>
<h5 id="具体配置"><a href="#具体配置" class="headerlink" title="具体配置"></a>具体配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sidekiq::Client.reliable_push! unless Rails.env.test?</span><br></pre></td></tr></table></figure>
<h4 id="Sidekiq具体执行job时从Redis消费"><a href="#Sidekiq具体执行job时从Redis消费" class="headerlink" title="Sidekiq具体执行job时从Redis消费"></a><code>Sidekiq</code>具体执行<code>job</code>时从<code>Redis</code>消费</h4><h5 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h5><p><code>Sidekiq</code>正在执行一个<code>job</code>的时候突然crash，在<code>Redis</code>中<code>job</code>已经被消费了，但是这个<code>job</code>却没有执行完毕，重启<code>Sidekiq</code>后这个<code>job</code>丢失</p>
<h5 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h5><p><code>Redis</code>中的队列统一都用的<code>Lists</code>数据结构<br>普通的出队操作是<code>BRPOP</code>，<code>Pro</code>版本用了<code>RPOPLPUSH</code>，区别如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// BRPOP会对queue这个队列执行出队操作</span><br><span class="line">// RPOPLPUSH会将queue1出队的job在queue2入队</span><br><span class="line">BRPOP queue</span><br><span class="line">RPOPLPUSH queue1 queue2</span><br></pre></td></tr></table></figure></p>
<p>所以本质上<code>Pro</code>新增了一个队列来保存正在执行的<code>job</code>，只有<code>job</code>执行成功后才会真正的出队</p>
<h5 id="具体配置-1"><a href="#具体配置-1" class="headerlink" title="具体配置"></a>具体配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sidekiq.configure_server do |config|</span><br><span class="line">  config.super_fetch!</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="job从scheduled-queue到enqueues-queue"><a href="#job从scheduled-queue到enqueues-queue" class="headerlink" title="job从scheduled queue到enqueues queue"></a><code>job</code>从<code>scheduled queue</code>到<code>enqueues queue</code></h4><h5 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h5><p>当<code>job</code>从<code>scheduled队列</code>到<code>等待执行队列</code>需要跟<code>Sidekiq</code>客户端进行两次交互</p>
<ol>
<li><code>Sidekiq</code>客户端请求<code>job</code>从<code>scheduled队列</code>出队</li>
<li><code>Sidekiq</code>客户端请求<code>job</code>进入<code>等待执行队列</code></li>
</ol>
<p>如果两步之间出现问题，很可能丢失这个<code>job</code></p>
<h5 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h5><p><code>Pro</code>用<code>Lua</code>重写了上述两个步骤并且保证其原子性</p>
<h5 id="具体配置-2"><a href="#具体配置-2" class="headerlink" title="具体配置"></a>具体配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sidekiq.configure_server do |config|</span><br><span class="line">  config.reliable_scheduler!</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="Expiring-Jobs"><a href="#Expiring-Jobs" class="headerlink" title="Expiring Jobs"></a><code>Expiring Jobs</code></h3><p>过期时间后这个<code>job</code>就不再执行了</p>
<p>initializer:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &apos;sidekiq/pro/expiry&apos;</span><br></pre></td></tr></table></figure></p>
<p>Statically:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class SomeWorker</span><br><span class="line">  include Sidekiq::Worker</span><br><span class="line">  sidekiq_options expires_in: 1.hour</span><br><span class="line">  ...</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>Dynamically:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// expires_in must be a relative time, not an absolute timestamp.</span><br><span class="line">SomeWorker.set(expires_in: 1.day).perform_async(...)</span><br></pre></td></tr></table></figure></p>
<h3 id="Web-UI支持搜索"><a href="#Web-UI支持搜索" class="headerlink" title="Web UI支持搜索"></a><code>Web UI</code>支持搜索</h3><p>Type any substring that can be found in the job data: the worker class, a snippet of the arguments, etc.<br><img src="https://camo.githubusercontent.com/7bda9dc773d43df7fcb7d5cb919c1eb217fde270/68747470733a2f2f662e636c6f75642e6769746875622e636f6d2f6173736574732f323931312f313631393436352f66343735323966322d353635372d313165332d386364312d3333383939656237326161642e706e67" alt="Alt text"><br>配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">require &apos;sidekiq-pro&apos;</span><br><span class="line">require &apos;sidekiq/pro/web&apos;</span><br><span class="line"></span><br><span class="line">Your::Application.routes.draw do</span><br><span class="line">  mount Sidekiq::Web =&gt; &apos;/sidekiq&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h3 id="job运行时的信息实时发送到Statsd上"><a href="#job运行时的信息实时发送到Statsd上" class="headerlink" title="job运行时的信息实时发送到Statsd上"></a><code>job</code>运行时的信息实时发送到<code>Statsd</code>上</h3><p><a href="https://github.com/mperham/sidekiq/wiki/Pro-Metrics" target="_blank" rel="noopener">官方文档</a></p>
<h4 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h4><p>Sidekiq Pro will send the following metrics for a worker named Foo::BarWorker:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jobs.Foo.BarWorker.count =&gt; counter</span><br><span class="line">jobs.Foo.BarWorker.success =&gt; counter</span><br><span class="line">jobs.Foo.BarWorker.failure =&gt; counter</span><br><span class="line">jobs.Foo.BarWorker.perform =&gt; gauge (time)</span><br><span class="line">jobs.Foo.BarWorker.perform_count =&gt; counter</span><br><span class="line">jobs.Foo.BarWorker.perform_sum =&gt; counter</span><br><span class="line">jobs.count =&gt; counter</span><br><span class="line">jobs.success =&gt; counter</span><br><span class="line">jobs.failure =&gt; counter</span><br></pre></td></tr></table></figure></p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>Sidekiq Pro can send runtime metrics to Statsd for distribution. Set up a global metrics handler and add the middleware to track job execution.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">require &apos;datadog/statsd&apos; # gem &apos;dogstatsd-ruby&apos;</span><br><span class="line">Sidekiq::Pro.dogstatsd = -&gt;&#123; Datadog::Statsd.new(&quot;metrics.example.com&quot;, 8125) &#125;</span><br><span class="line"></span><br><span class="line">Sidekiq.configure_server do |config|</span><br><span class="line">  config.server_middleware do |chain|</span><br><span class="line">    require &apos;sidekiq/middleware/server/statsd&apos;</span><br><span class="line">    chain.add Sidekiq::Middleware::Server::Statsd</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<h3 id="Pro-API"><a href="#Pro-API" class="headerlink" title="Pro API"></a><code>Pro</code> API</h3><p><a href="https://github.com/mperham/sidekiq/wiki/Pro-API" target="_blank" rel="noopener">官方文档</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jid = MyWorker.perform_async</span><br><span class="line">queue = Sidekiq::Queue.new</span><br><span class="line">queue.delete_job(jid)</span><br><span class="line"></span><br><span class="line">MyWorker.perform_async</span><br><span class="line">queue = Sidekiq::Queue.new</span><br><span class="line">queue.delete_by_class(MyWorker)</span><br></pre></td></tr></table></figure></p>
<h3 id="Batches"><a href="#Batches" class="headerlink" title="Batches"></a>Batches</h3><p><a href="https://github.com/mperham/sidekiq/wiki/Batches" target="_blank" rel="noopener">官方文档</a></p>
<p>You can create a set of jobs to execute in parallel and then execute a callback when all the jobs are finished.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Sidekiq/" rel="tag"># Sidekiq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/economic-explanation/" rel="next" title="经济解释 第一章">
                <i class="fa fa-chevron-left"></i> 经济解释 第一章
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/economic-explanation2/" rel="prev" title="经济解释 第二三章">
                经济解释 第二三章 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://user-images.githubusercontent.com/10556018/53352661-27443000-395e-11e9-8d7b-86c57c4968aa.png"
                alt="Haile Huang" />
            
              <p class="site-author-name" itemprop="name">Haile Huang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/HaileHuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/Tim_Rosses" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#job-lifecycle"><span class="nav-number">1.</span> <span class="nav-text">job lifecycle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项"><span class="nav-number">2.</span> <span class="nav-text">注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#证明改变worker后重启Sidekiq-，之前的job用的是新的worker的代码"><span class="nav-number">2.1.</span> <span class="nav-text">证明改变worker后重启Sidekiq ，之前的job用的是新的worker的代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#第一步"><span class="nav-number">2.1.1.</span> <span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二步"><span class="nav-number">2.1.2.</span> <span class="nav-text">第二步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三步"><span class="nav-number">2.1.3.</span> <span class="nav-text">第三步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第四步"><span class="nav-number">2.1.4.</span> <span class="nav-text">第四步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结论"><span class="nav-number">2.1.5.</span> <span class="nav-text">结论</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优雅、安全的shut-down-Sidekiq"><span class="nav-number">2.2.</span> <span class="nav-text">优雅、安全的shut down Sidekiq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保持job参数的简单"><span class="nav-number">2.3.</span> <span class="nav-text">保持job参数的简单</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#工作中的最佳实践"><span class="nav-number">2.3.1.</span> <span class="nav-text">工作中的最佳实践</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保持job的幂等性和事务性"><span class="nav-number">2.4.</span> <span class="nav-text">保持job的幂等性和事务性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#工作中的最佳实践-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">工作中的最佳实践</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pro版本优点"><span class="nav-number">3.</span> <span class="nav-text">pro版本优点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更好的可靠性"><span class="nav-number">3.1.</span> <span class="nav-text">更好的可靠性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sidekiq客户端推送job到Redis"><span class="nav-number">3.1.1.</span> <span class="nav-text">Sidekiq客户端推送job到Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#问题描述"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方案"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#具体配置"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">具体配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sidekiq具体执行job时从Redis消费"><span class="nav-number">3.1.2.</span> <span class="nav-text">Sidekiq具体执行job时从Redis消费</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#问题描述-1"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方案-1"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#具体配置-1"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">具体配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#job从scheduled-queue到enqueues-queue"><span class="nav-number">3.1.3.</span> <span class="nav-text">job从scheduled queue到enqueues queue</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#问题描述-2"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方案-2"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#具体配置-2"><span class="nav-number">3.1.3.3.</span> <span class="nav-text">具体配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Expiring-Jobs"><span class="nav-number">3.2.</span> <span class="nav-text">Expiring Jobs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Web-UI支持搜索"><span class="nav-number">3.3.</span> <span class="nav-text">Web UI支持搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#job运行时的信息实时发送到Statsd上"><span class="nav-number">3.4.</span> <span class="nav-text">job运行时的信息实时发送到Statsd上</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Metrics"><span class="nav-number">3.4.1.</span> <span class="nav-text">Metrics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置"><span class="nav-number">3.4.2.</span> <span class="nav-text">配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pro-API"><span class="nav-number">3.5.</span> <span class="nav-text">Pro API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Batches"><span class="nav-number">3.6.</span> <span class="nav-text">Batches</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Haile Huang</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hailehuang.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.hailehuang.com/sidekiq/';
          this.page.identifier = 'sidekiq/';
          this.page.title = 'Sidekiq';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://hailehuang.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
